package com.suse.marcher;

import java.util.List;

import com.suse.matcher.model.Subscription;
import com.suse.matcher.model.System;

/* Layer 1 - expose partnumbers to more facts */
rule "partnumber 874-005030"
	when
		$subscription : Subscription(partnumber == "874-005030")
	then
		modify($subscription) {
			cpus = 32,
			unlimitedVirtualization = true,
			stackable = false,
			usableProductIds.add("1"),
			supportType = "Standard",
			lifetime = 3;
		};
end

rule "virtual systems to hostId"
when
	$guest : System(hostId == null)
	$host  : System(virtualSystems contains $guest.id )
then
	modify($guest) { hostId = $host.id; }
end

rule "hostId to virtual systems"
when
	$guest : System(hostId != null)
	$host  : System(id == $guest.hostId, virtualSystems not contains $guest.id )
then
	modify($host) { virtualSystems.add($guest.id); }
end


/* Layer 2 - create a set of matching subscriptions for systems */
rule "installed product matches subscription"
    when
        $system : System()
        $subscription : Subscription( matchAnyProductOnSystem($system),
            (stackable == true || cpus >= $system.cpus ),
            (unlimitedVirtualization == true || $system.virtualSystems.size() == 0) )
    then
        //System.out.println( "test" );
        modify($system) { applicableSubscriptions.add($subscription); }
end

/* Layer 3 - select a result */


